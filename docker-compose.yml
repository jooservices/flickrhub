services:
  api:
    build: .
    command: sh -c "cp -n .env.example .env && pm2-runtime ecosystem.config.js --only api"
    env_file: .env
    environment:
      - PM2_TARGET=api
      - REDIS_URL=redis://redis:6379
      - MONGO_URL=mongodb://mongo:27017/flickrhub
      - RABBIT_URL=amqp://rabbit:5672
    ports:
      - '3000:3000'
    depends_on:
      redis:
        condition: service_healthy
      mongo:
        condition: service_healthy
      rabbit:
        condition: service_healthy

  worker_rest:
    build: .
    command: sh -c "cp -n .env.example .env && pm2-runtime ecosystem.config.js --only worker-rest"
    env_file: .env
    environment:
      - PM2_TARGET=worker-rest
      - QUEUE_NAME=flickr_rest
      - WORKER_REST_INSTANCES=${WORKER_REST_INSTANCES:-5}
      - WORKER_REST_CONCURRENCY=${WORKER_REST_CONCURRENCY:-1}
      - REDIS_URL=redis://redis:6379
      - MONGO_URL=mongodb://mongo:27017/flickrhub
      - RABBIT_URL=amqp://rabbit:5672
    depends_on:
      redis:
        condition: service_healthy
      mongo:
        condition: service_healthy
      rabbit:
        condition: service_healthy
    restart: unless-stopped

  worker_upload:
    build: .
    command: sh -c "cp -n .env.example .env && pm2-runtime ecosystem.config.js --only worker-upload"
    env_file: .env
    environment:
      - PM2_TARGET=worker-upload
      - QUEUE_NAME=flickr_upload
      - WORKER_UPLOAD_INSTANCES=${WORKER_UPLOAD_INSTANCES:-5}
      - WORKER_UPLOAD_CONCURRENCY=${WORKER_UPLOAD_CONCURRENCY:-1}
      - REDIS_URL=redis://redis:6379
      - MONGO_URL=mongodb://mongo:27017/flickrhub
      - RABBIT_URL=amqp://rabbit:5672
    depends_on:
      redis:
        condition: service_healthy
      mongo:
        condition: service_healthy
      rabbit:
        condition: service_healthy
    restart: unless-stopped

  worker_replace:
    build: .
    command: sh -c "cp -n .env.example .env && pm2-runtime ecosystem.config.js --only worker-replace"
    env_file: .env
    environment:
      - PM2_TARGET=worker-replace
      - QUEUE_NAME=flickr_replace
      - WORKER_REPLACE_INSTANCES=${WORKER_REPLACE_INSTANCES:-5}
      - WORKER_REPLACE_CONCURRENCY=${WORKER_REPLACE_CONCURRENCY:-1}
      - REDIS_URL=redis://redis:6379
      - MONGO_URL=mongodb://mongo:27017/flickrhub
      - RABBIT_URL=amqp://rabbit:5672
    depends_on:
      redis:
        condition: service_healthy
      mongo:
        condition: service_healthy
      rabbit:
        condition: service_healthy
    restart: unless-stopped

  rabbit:
    image: rabbitmq:3-management-alpine
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    healthcheck:
      test: ['CMD', 'rabbitmq-diagnostics', '-q', 'status']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: ['redis-server', '--save', '900', '1', '--appendonly', 'yes']
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    restart: unless-stopped

  mongo:
    image: mongo:7
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ['CMD', 'mongosh', '--quiet', 'mongodb://localhost:27017/test', '--eval', 'db.runCommand({ ping: 1 })']
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 10s
    restart: unless-stopped

volumes:
  mongo_data:
  redis_data:
  rabbitmq_data:
