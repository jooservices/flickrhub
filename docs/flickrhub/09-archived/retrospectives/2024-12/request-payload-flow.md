# Request/Payload Flow Documentation

Chi tiết về các request và payload trong flow từ Client → FlickrHub → Flickr → Callback → Client.

---

## 1. Client → FlickrHub (FH) API

### Endpoint

```
POST http://localhost:3000/api/v1/flickr/rest
```

### Request Headers

```http
Content-Type: application/json
```

### Request Body (Client → FH)

```json
{
  "method": "flickr.test.echo",
  "params": {
    "name": "callback-test"
  },
  "user_id": "09b4e414-4f70-4226-9ee8-f9e815fc2539",
  "target": "rest",
  "callback_url": "http://host.docker.internal:4001/callback",
  "callback_secret": "test-secret-123"
}
```

**Field Descriptions:**

- `method` (required): Flickr API method name (e.g., `flickr.test.echo`, `flickr.photos.search`)
- `params` (required, object): Parameters for the Flickr API method
- `user_id` (required, string): User ID obtained from OAuth flow
- `target` (optional, string): Queue target - `"rest"` | `"upload"` | `"replace"` (default: `"rest"`)
- `callback_url` (optional, string): URL to receive callback when job completes
- `callback_secret` (optional, string): Secret for HMAC signature in callback header

### Response (FH → Client)

```json
{
  "request_id": "req-1e",
  "data": {
    "job_id": "e6b6634c-e07c-43f0-88b3-9516590aad77"
  },
  "error": null
}
```

**HTTP Status:** `202 Accepted`

---

## 2. FlickrHub → RabbitMQ Message

### Queue Name

- `flickr_rest` (for target: `rest`)
- `flickr_upload` (for target: `upload`)
- `flickr_replace` (for target: `replace`)

### Message Payload (FH → RabbitMQ)

```json
{
  "jobId": "e6b6634c-e07c-43f0-88b3-9516590aad77",
  "method": "flickr.test.echo",
  "params": {
    "name": "callback-test"
  },
  "userId": "09b4e414-4f70-4226-9ee8-f9e815fc2539",
  "target": "rest",
  "url": "https://api.flickr.com/services/rest",
  "callbackUrl": "http://host.docker.internal:4001/callback",
  "callbackSecret": "test-secret-123",
  "traceId": "req-1e",
  "requestMeta": {
    "ip": "127.0.0.1",
    "userAgent": "curl/7.68.0"
  }
}
```

**Note:**

- `callbackUrl` and `callbackSecret` are only included if provided (using conditional spread operator)
- Fields are converted from snake_case (`callback_url`) to camelCase (`callbackUrl`)

---

## 3. FlickrHub Worker → Flickr API

### Endpoint

```
POST https://api.flickr.com/services/rest
```

### Request Headers

```http
Content-Type: application/x-www-form-urlencoded
```

### Request Body (FH Worker → Flickr)

```
method=flickr.test.echo
&format=json
&nojsoncallback=1
&name=callback-test
&oauth_consumer_key=YOUR_FLICKR_API_KEY
&oauth_nonce=685c314b7707fc7a
&oauth_signature=2705STPmUlEqTHPZN67RC7TR1tg=          # example signature
&oauth_signature_method=HMAC-SHA1
&oauth_timestamp=1764803161
&oauth_token=YOUR_OAUTH_TOKEN
&oauth_version=1.0
&api_auth_is_oauth=1
&api_key=YOUR_FLICKR_API_KEY
&api_sig=2705STPmUlEqTHPZN67RC7TR1tg=                  # example signature
&auth_token=YOUR_OAUTH_TOKEN
```

**Note:**

- OAuth 1.0 authentication is automatically added by FlickrClient
- Parameters from client request are included
- Additional OAuth parameters are generated by FlickrClient

### Response (Flickr → FH Worker)

```json
{
  "method": {
    "_content": "flickr.test.echo"
  },
  "format": {
    "_content": "json"
  },
  "nojsoncallback": {
    "_content": "1"
  },
  "name": {
    "_content": "callback-test"
  },
  "oauth_consumer_key": {
    "_content": "YOUR_FLICKR_API_KEY"
  },
  "oauth_nonce": {
    "_content": "685c314b7707fc7a"
  },
  "oauth_signature": {
    "_content": "2705STPmUlEqTHPZN67RC7TR1tg="
  },
  "oauth_signature_method": {
    "_content": "HMAC-SHA1"
  },
  "oauth_timestamp": {
    "_content": "1764803161"
  },
  "oauth_token": {
    "_content": "YOUR_OAUTH_TOKEN"
  },
  "oauth_version": {
    "_content": "1.0"
  },
  "api_auth_is_oauth": {
    "_content": "1"
  },
  "api_key": {
    "_content": "YOUR_FLICKR_API_KEY"
  },
  "api_sig": {
    "_content": "2705STPmUlEqTHPZN67RC7TR1tg="
  },
  "auth_token": {
    "_content": "YOUR_OAUTH_TOKEN"
  },
  "stat": "ok"
}
```

---

## 4. FlickrHub Worker → Client Callback

### Endpoint

```
POST http://host.docker.internal:4001/callback
```

_(URL from `callback_url` in original request)_

### Request Headers

```http
Content-Type: application/json
X-Signature: 9e36482970235ca1f375fa663e502869187b1530b20e3d534d033e710ede4e10
```

**Signature Calculation:**

```
HMAC-SHA256(JSON_BODY, callback_secret)
```

### Request Body (FH Worker → Client Callback)

```json
{
  "job_id": "e6b6634c-e07c-43f0-88b3-9516590aad77",
  "user_id": "09b4e414-4f70-4226-9ee8-f9e815fc2539",
  "queue": "flickr_rest",
  "state": "completed",
  "result": {
    "method": {
      "_content": "flickr.test.echo"
    },
    "format": {
      "_content": "json"
    },
    "nojsoncallback": {
      "_content": "1"
    },
    "name": {
      "_content": "callback-test"
    },
    "oauth_consumer_key": {
      "_content": "YOUR_FLICKR_API_KEY"
    },
    "oauth_nonce": {
      "_content": "685c314b7707fc7a"
    },
    "oauth_signature": {
      "_content": "2705STPmUlEqTHPZN67RC7TR1tg="
    },
    "oauth_signature_method": {
      "_content": "HMAC-SHA1"
    },
    "oauth_timestamp": {
      "_content": "1764803161"
    },
    "oauth_token": {
      "_content": "YOUR_OAUTH_TOKEN"
    },
    "oauth_version": {
      "_content": "1.0"
    },
    "api_auth_is_oauth": {
      "_content": "1"
    },
    "api_key": {
      "_content": "YOUR_FLICKR_API_KEY"
    },
    "api_sig": {
      "_content": "2705STPmUlEqTHPZN67RC7TR1tg="
    },
    "auth_token": {
      "_content": "YOUR_OAUTH_TOKEN"
    },
    "stat": "ok"
  },
  "error": null,
  "from_cache": false,
  "attempts_made": 0,
  "max_attempts": 3,
  "timestamp": "2025-12-03T23:07:17.963Z",
  "trace_id": "req-1e"
}
```

**Field Descriptions:**

- `job_id` (string): Job ID returned from enqueue endpoint
- `user_id` (string): User ID from original request
- `queue` (string): Queue name where job was processed
- `state` (string): Job state - `"completed"` | `"failed"`
- `result` (object | null): Flickr API response (if completed)
- `error` (object | null): Error details (if failed)
  ```json
  {
    "message": "Error message",
    "code": null
  }
  ```
- `from_cache` (boolean): Whether result was served from cache
- `attempts_made` (number): Number of attempts made
- `max_attempts` (number): Maximum retry attempts configured
- `timestamp` (string): ISO 8601 timestamp when callback is sent
- `trace_id` (string): Request trace ID for correlation

### Response (Client Callback → FH Worker)

```json
{
  "status": "ok"
}
```

**HTTP Status:** `200 OK`

**Note:** Worker expects `200 OK` status. Other status codes or failures will trigger retry logic.

---

## 5. Failed Job Callback Example

### Request Body (FH Worker → Client Callback - Failed)

```json
{
  "job_id": "e6b6634c-e07c-43f0-88b3-9516590aad77",
  "user_id": "09b4e414-4f70-4226-9ee8-f9e815fc2539",
  "queue": "flickr_rest",
  "state": "failed",
  "result": null,
  "error": {
    "message": "Token not found for userId=...",
    "code": null
  },
  "from_cache": false,
  "attempts_made": 3,
  "max_attempts": 3,
  "timestamp": "2025-12-03T23:07:17.963Z",
  "trace_id": "req-1e"
}
```

---

## Complete Flow Diagram

```
┌─────────┐
│ Client  │
└────┬────┘
     │
     │ 1. POST /api/v1/flickr/rest
     │    { method, params, user_id, callback_url, ... }
     │
     ▼
┌─────────────────┐
│  FH API Server  │
└────┬────────────┘
     │
     │ 2. Create Job, Store in MongoDB
     │    Save callbackUrl to MongoDB
     │
     │ 3. Publish to RabbitMQ
     │    { jobId, method, params, callbackUrl, ... }
     │
     ▼
┌──────────────┐
│  RabbitMQ    │
│  (Queue)     │
└────┬─────────┘
     │
     │ 4. Worker consumes message
     │
     ▼
┌─────────────────┐
│  FH Worker      │
└────┬────────────┘
     │
     │ 5. POST https://api.flickr.com/services/rest
     │    { method, params, oauth_params, ... }
     │
     ▼
┌──────────┐
│  Flickr  │
│   API    │
└────┬─────┘
     │
     │ 6. Response: { stat: "ok", ... }
     │
     ▼
┌─────────────────┐
│  FH Worker      │
└────┬────────────┘
     │
     │ 7. POST callback_url
     │    { job_id, state: "completed", result, ... }
     │    Headers: X-Signature: HMAC-SHA256(...)
     │
     ▼
┌─────────┐
│ Client  │
│Callback │
└─────────┘
```

---

## Signature Verification (Client Side)

### Node.js Example

```javascript
const crypto = require('crypto');

function verifyCallbackSignature(body, signature, secret) {
  const jsonString = JSON.stringify(body);
  const expectedSig = crypto.createHmac('sha256', secret).update(jsonString).digest('hex');
  return crypto.timingSafeEqual(Buffer.from(signature), Buffer.from(expectedSig));
}

// Usage
const isValid = verifyCallbackSignature(callbackBody, req.headers['x-signature'], callbackSecret);
```

### Python Example

```python
import hmac
import hashlib
import json

def verify_callback_signature(body, signature, secret):
    json_string = json.dumps(body, sort_keys=True)
    expected_sig = hmac.new(
        secret.encode('utf-8'),
        json_string.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(signature, expected_sig)
```

---

## Notes

1. **Callback URL Format:**
   - From Docker worker: Use `host.docker.internal:PORT` to reach host
   - From same network: Use service names or internal DNS
   - From external: Use full domain names

2. **Retry Logic:**
   - Callback retries on failure (configurable via `CALLBACK_RETRY_ATTEMPTS`)
   - Retry delay between attempts (configurable via `CALLBACK_RETRY_DELAY_MS`)

3. **Security:**
   - Always verify `X-Signature` header if `callback_secret` is provided
   - Use HTTPS for callback URLs in production

4. **Field Naming:**
   - API uses `snake_case` (e.g., `callback_url`)
   - Internal code uses `camelCase` (e.g., `callbackUrl`)
   - Conversion happens at API boundary

---

**Last Updated:** 2025-12-03
**Tested:** ✅ Verified with E2E tests
